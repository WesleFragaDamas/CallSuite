{% extends "core/base.html" %}
{% load static %}
{# {% load crispy_forms_tags %} Não é estritamente necessário aqui se não houver outros forms Django #}

{% block title %}{{ page_title }} - CallSuite{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
    .results-table th, .results-table td { font-size: 0.8rem; padding: 0.35rem; text-align: center; vertical-align: middle; }
    .results-table input[type="number"].input-agentes-simulados { /* Renomeado para clareza */
        width: 65px;
        padding: 0.2rem;
        font-size: 0.8rem;
        text-align: center;
        border-radius: 0.2rem;
    }
    .table-sticky-header thead th { position: sticky; top: 0; z-index: 1; background-color: #f8f9fa !important; /* Importante para sobrepor scrollbars do Bootstrap */}
    .table-responsive.fixed-header { max-height: 70vh; /* Altura da tabela antes do scroll interno */ }

    /* Classes para highlight de SLA e Ocupação */
    .highlight-sla-bad { color: #dc3545 !important; font-weight: bold !important; }
    .highlight-sla-good { color: #198754 !important; }
    .highlight-ocup-high { color: #ffc107 !important; /* Laranja para ocupação alta */ }
    .highlight-ocup-very-high { color: #dc3545 !important; font-weight: bold !important; } /* Vermelho para muito alta */
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-0">{{ page_title }}</h1>
            {% if cenario %}
            <small class="text-muted">Cenário: {{ cenario.nome_cenario }} | Data Ref: {{ cenario.data_referencia|date:"d/m/Y" }}</small>
            {% endif %}
        </div>
        {% if cenario and perms.dimensionamento.change_cenariodimensionamento %}
        <a href="{% url 'dimensionamento:editar_cenario' cenario_id=cenario.id %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-pencil-square"></i> Editar Parâmetros do Cenário
        </a>
        {% endif %}
    </div>

    {% if cenario %}
    <div class="card mb-3">
        <div class="card-body p-2" style="font-size: 0.85rem;">
            <strong>TMA:</strong> {{ cenario.tma_segundos }}s |
            <strong>SLA Meta:</strong> {{ nivel_servico_percentual_meta_para_js|floatformat:0 }}% em {{ cenario.nivel_servico_tempo_meta_segundos }}s |
            <strong>Shrinkage Aplicado:</strong> {{ display_fator_shrinkage_calculado|floatformat:2 }}
            ({% if display_fator_shrinkage_calculado > 1 %}{{ display_fator_shrinkage_extra_percent|floatformat:2 }}{% else %}0.00{% endif %}% extra)
        </div>
    </div>
    {% endif %}

    {% if erro_calculo %}
        <div class="alert alert-danger">{{ erro_calculo }}</div>
    {% endif %}

    {% if resultados %}
    <div class="table-responsive fixed-header">
        <table class="table table-bordered table-hover results-table table-sticky-header">
            <thead class="table-light">
                <tr>
                    <th rowspan="2" class="align-middle">Intervalo</th>
                    <th rowspan="2" class="align-middle">Chamadas <br/><small>(Input)</small></th>
                    <th colspan="2">Dimensionado <small>(Erlang+Shrink.)</small></th>
                    <th colspan="3">Simulação Interativa</th>
                </tr>
                <tr>
                    <th>Ag. Brutos <br/><small>(Erlang)</small></th>
                    <th>Ag. Rec. <br/><small>(+Shrink.)</small></th>
                    <th>Ag. Simulados <br/><small>(Editável)</small></th>
                    <th>SLA Simulado <br/><small>(%)</small></th>
                    <th>Ocup. Simulada <br/><small>(%)</small></th>
                </tr>
            </thead>
            <tbody>
                {% for res in resultados %}
                <tr id="intervalo-row-{{ res.intervalo_pk_str }}"
                    data-volume-intervalo="{{ res.volume_chamadas }}"
                    data-tma-cenario="{{ cenario.tma_segundos }}"
                    data-meta-sla-tempo="{{ cenario.nivel_servico_tempo_meta_segundos }}">
                    <td>{{ res.intervalo_str }}</td>
                    <td>{{ res.volume_chamadas }}</td>
                    <td>{{ res.agentes_brutos_erlang|floatformat:0 }}</td>
                    <td>{{ res.agentes_recomendados_com_shrinkage|floatformat:0 }}</td>
                    <td>
                        <input type="number"
                               class="form-control form-control-sm input-agentes-simulados"
                               value="{{ res.agentes_para_simulacao_inicial|floatformat:0 }}"
                               data-intervalo-pk-str="{{ res.intervalo_pk_str }}"
                               min="0" step="1">
                    </td>
                    <td class="sla-simulado-display">
                        {{ res.sla_previsto_base|floatformat:2 }}%
                    </td>
                    <td class="ocupacao-simulada-display">
                        {{ res.ocupacao_prevista_base|floatformat:2 }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif not erro_calculo %}
        <div class="alert alert-info mt-3">Nenhum resultado para exibir. Verifique os parâmetros e dados do cenário ou se o cálculo foi executado.</div>
    {% endif %}
    <div class="mt-3">
        <a href="{% url 'dimensionamento:lista_cenarios' %}" class="btn btn-secondary btn-sm">Voltar à Lista de Cenários</a>
        {# Futuro: Botão para Salvar Simulação Otimizada / Exportar Resultados #}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
    // Variável global passada pelo template Django, crucial para highlights
    const META_SLA_ALVO_PERCENT_JS = parseFloat("{{ nivel_servico_percentual_meta_para_js|default:'80.0' }}");

    // =================================================================================
    // == FUNÇÕES JAVASCRIPT DE ERLANG C DE EXEMPLO (SUBSTITUA PELAS SUAS DEPOIS) ==
    // =================================================================================
    function factorialJs(n_float) {
        let n = Math.floor(n_float); // Garante que é inteiro para o loop
        if (n < 0) return NaN;
        if (n === 0 || n === 1) return 1;
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return result;
    }

    function erlangCProbabilityOfWaiting(A, N_float) {
        let N = Math.floor(N_float);
        if (N <= 0) return 1.0;
        if (A <= 0) return 0.0;
        if (N <= A) return 0.99999;

        try {
            let sumVal = 0;
            for (let k = 0; k < N; k++) {
                const termK = Math.pow(A, k) / factorialJs(k);
                if (!isFinite(termK)) { sumVal = Infinity; break; } // Evita NaN se A^k for muito grande
                sumVal += termK;
            }
            if (!isFinite(sumVal)) return 0.99999;


            const term_A_N_div_N_fact = (Math.pow(A, N) / factorialJs(N));
            if (!isFinite(term_A_N_div_N_fact)) return 0.99999;

            const numeratorPw = term_A_N_div_N_fact * (N / (N - A));
            if (!isFinite(numeratorPw) || (N-A) <= 0) return 0.99999; // N deve ser > A


            const denominatorPw = sumVal + numeratorPw;
            if (denominatorPw === 0) return 1.0;

            let Pw = numeratorPw / denominatorPw;
            return Math.max(0, Math.min(Pw, 1.0));
        } catch (e) {
            console.error("Erro em erlangCProbabilityOfWaiting:", e, "A:", A, "N:", N);
            return 0.99999;
        }
    }

    function calculateServiceLevelJs(A, N, tmaSeconds, targetTimeSeconds) {
        if (N <= 0 || tmaSeconds <= 0) return 0.0;
        if (A <= 0) return 1.0;
        if (N <= A) return 0.00001;

        const Pw = erlangCProbabilityOfWaiting(A, N);
        const exponentFactor = (N - A) * (targetTimeSeconds / tmaSeconds);
        let serviceLevel = 1.0 - (Pw * Math.exp(-exponentFactor));
        return Math.max(0, Math.min(serviceLevel, 1.0));
    }

    function calculateOccupancyJs(A, N) {
        if (N === 0) return Infinity;
        if (A === 0) return 0.0;
        const occupancy = A / N;
        return Math.min(1.0, occupancy);
    }
    // =================================================================================

    document.addEventListener('DOMContentLoaded', function() {
        // Função showToast (mantenha-a como estava)
        function showToast(message, type = 'info') {
            const container = document.querySelector('.toast-container');
            if (!container) { console.warn("Toast container não encontrado, usando console para:", message); return; }
            const id = 'toast-' + Date.now();
            const bgClass = (type === 'error' || type === 'danger' ? 'danger' : (type === 'warning' ? 'warning' : (type === 'success' ? 'success' : 'info')));
            const html = `<div id="${id}" class="toast align-items-center text-white bg-${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
            container.insertAdjacentHTML('beforeend', html);
            const el = document.getElementById(id);
            if (el) {
                const toast = new bootstrap.Toast(el, { delay: 3500 });
                toast.show();
                el.addEventListener('hidden.bs.toast', () => el.remove());
            }
        }

        const inputsAgentesSimulados = document.querySelectorAll('.input-agentes-simulados');

        inputsAgentesSimulados.forEach(input => {
            input.dataset.previousValue = input.value;

            input.addEventListener('change', function() {
                const agentesSimulados = parseInt(this.value);
                const row = this.closest('tr');

                const volumeIntervalo = parseInt(row.dataset.volumeIntervalo);
                const tmaCenarioSeg = parseInt(row.dataset.tmaCenario);
                const metaSlaTempoSeg = parseInt(row.dataset.metaSlaTempo);

                const slaCell = row.querySelector('.sla-simulado-display');
                const ocupacaoCell = row.querySelector('.ocupacao-simulada-display');

                if (isNaN(agentesSimulados) || agentesSimulados < 0) {
                    showToast("Agentes simulados: valor inválido.", "danger");
                    this.value = this.dataset.previousValue;
                    // Recalcular com o valor anterior para restaurar SLA/Ocup
                    // Ou simplesmente não fazer nada e deixar os valores antigos de SLA/Ocup
                    // Para simplificar, vamos recalcular com o valor anterior:
                    const prevAgentes = parseInt(this.dataset.previousValue);
                    if (!isNaN(prevAgentes)) {
                         // Re-chama a lógica de cálculo com o valor anterior
                        performCalculationAndUpdateRow(prevAgentes, volumeIntervalo, tmaCenarioSeg, metaSlaTempoSeg, slaCell, ocupacaoCell);
                    }
                    return;
                }
                this.dataset.previousValue = this.value; // Atualiza o "anterior" para o novo válido

                performCalculationAndUpdateRow(agentesSimulados, volumeIntervalo, tmaCenarioSeg, metaSlaTempoSeg, slaCell, ocupacaoCell);
            });
        });

        function performCalculationAndUpdateRow(agentes, volume, tma, metaTempo, slaCell, ocupacaoCell) {
            if (volume === 0) {
                if(slaCell) slaCell.textContent = "100.00%";
                if(ocupacaoCell) ocupacaoCell.textContent = "0.00%";
                applyHighlights(slaCell, 100, ocupacaoCell, 0);
                return;
            }
            if (agentes === 0 && volume > 0) {
                if(slaCell) slaCell.textContent = "0.00%";
                if(ocupacaoCell) ocupacaoCell.textContent = "Inf%";
                applyHighlights(slaCell, 0, ocupacaoCell, Infinity);
                return;
            }

            const volumeHoraEquivalente = volume * 2;
            const trafficIntensityA = (volumeHoraEquivalente * tma) / 3600.0;

            let novoSlaPrevistoPercent = 0;
            let novaOcupacaoPrevistaPercent = 0;

            if (typeof calculateServiceLevelJs === 'function' && typeof calculateOccupancyJs === 'function') {
                novoSlaPrevistoPercent = calculateServiceLevelJs(trafficIntensityA, agentes, tma, metaTempo) * 100;
                novaOcupacaoPrevistaPercent = calculateOccupancyJs(trafficIntensityA, agentes) * 100;
                novaOcupacaoPrevistaPercent = Math.min(100, (novaOcupacaoPrevistaPercent > 0 && isFinite(novaOcupacaoPrevistaPercent)) ? novaOcupacaoPrevistaPercent : 0);
            } else {
                console.error("Funções Erlang JS (calculateServiceLevelJs, calculateOccupancyJs) não definidas!");
                if(slaCell) slaCell.textContent = "Erro Calc.";
                if(ocupacaoCell) ocupacaoCell.textContent = "Erro Calc.";
                return;
            }

            if(slaCell) slaCell.textContent = `${novoSlaPrevistoPercent.toFixed(2)}%`;
            if(ocupacaoCell) ocupacaoCell.textContent = `${novaOcupacaoPrevistaPercent.toFixed(2)}%`;

            applyHighlights(slaCell, novoSlaPrevistoPercent, ocupacaoCell, novaOcupacaoPrevistaPercent);
        }


        function applyHighlights(slaCell, slaValue, ocupacaoCell, ocupValue) {
            if (slaCell && !isNaN(slaValue)) {
                slaCell.classList.remove('highlight-sla-bad', 'highlight-sla-good');
                if (slaValue < META_SLA_ALVO_PERCENT_JS) slaCell.classList.add('highlight-sla-bad');
                else if (slaValue >= 99.9) slaCell.classList.add('highlight-sla-good');
            }
            if (ocupacaoCell && !isNaN(ocupValue) && isFinite(ocupValue)) { // Adicionado isFinite
                ocupacaoCell.classList.remove('highlight-ocup-very-high', 'highlight-ocup-high');
                if (ocupValue > 95) ocupacaoCell.classList.add('highlight-ocup-very-high');
                else if (ocupValue > 85) ocupacaoCell.classList.add('highlight-ocup-high');
            } else if (ocupacaoCell && !isFinite(ocupValue)) { // Caso de Ocupação Infinita
                 ocupacaoCell.classList.remove('highlight-ocup-very-high', 'highlight-ocup-high');
                 ocupacaoCell.classList.add('highlight-ocup-very-high'); // Trata como muito alta
            }
        }

        // Aplica highlights iniciais
        document.querySelectorAll('.results-table tbody tr').forEach(row => {
            const slaCell = row.querySelector('.sla-simulado-display');
            const ocupacaoCell = row.querySelector('.ocupacao-simulada-display');
            const inputAgentes = row.querySelector('.input-agentes-simulados');

            if (slaCell && ocupacaoCell && inputAgentes) {
                // Simula um evento 'change' para calcular e aplicar highlights com os valores iniciais
                // Isso garante que a lógica de cálculo e highlight seja a mesma da edição.
                const changeEvent = new Event('change');
                inputAgentes.dispatchEvent(changeEvent);
            }
        });
        console.log("JS: resultados_cenario.js carregado e pronto para simulação no frontend.");
    });
</script>
{% endblock %}